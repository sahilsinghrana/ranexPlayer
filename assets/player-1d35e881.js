var L=Object.defineProperty;var f=(a,e,t)=>e in a?L(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var u=(a,e,t)=>(f(a,typeof e!="symbol"?e+"":e,t),t);import{g as x}from"./moonAndMusicImages-ee3f4190.js";import{Q as s}from"./index-077007ab.js";import{b as P,a as o,p as r,d as h,e as E,c as q}from"./playerAtom-ef4b5b77.js";import{c as d}from"./helpers-b6ef1e89.js";import{c as v}from"./imageHelpers-8dffa84a.js";const b=()=>"mediaSession"in navigator,N=()=>navigator.mediaSession,I=a=>{b()&&(N().playbackState=a)};class Q{constructor(){u(this,"listenSongChange");u(this,"queue",{id:"",name:"",queue:[],nowPlayingIdx:null});u(this,"seek",e=>{this.audioEl.currentTime=e});this.audioEl=new Audio,this.meta={}}attachListener(e,t){if(e==="songchange"){this.listenSongChange=t;return}this.audioEl.addEventListener(e,t)}setNowPlayingIndex(e){this.queue.nowPlayingIdx=e}getSongByQueueIdx(e){return this.queue.queue[e]||{}}queueLength(){return this.queue.queue.length}resetQueue(e,t="Now Playing",n=[]){this.queue={queue:n,queueId:e,name:t}}load(e,t={}){let n=e;if(console.log(e),Array.isArray(e)){if(!e.length)return;n=e[0].song,t=e[0].meta,this.resetQueue(123,"Now Playing",e),this.setNowPlayingIndex(0)}else this.resetQueue(123,"Now Playing",[e]),this.setNowPlayingIndex(0);this.loadSong(n,t)}loadSong(e,t){this.listenSongChange(e,t),this.meta=t,this.audioEl.src=e,this.audioEl.load()}loadAndPlay(e,t={}){this.loadSong(e,t),this.play()}play(){this.audioEl.play(),I("playing")}pause(){this.audioEl.pause(),I("paused")}next(){let e=this.queue.nowPlayingIdx+1;e>this.queueLength()-1&&(e=0);const{song:t,meta:n}=this.getSongByQueueIdx(e);t&&(this.setNowPlayingIndex(e),this.loadAndPlay(t,n))}prev(){let e=this.queue.nowPlayingIdx-1;e<0&&(e=this.queueLength()-1);const{song:t,meta:n}=this.getSongByQueueIdx(e);t&&(this.setNowPlayingIndex(e),this.loadAndPlay(t,n))}changeVolume(e=0){this.audioEl.volume=e}}const i=new Q;s.set(P,()=>i.audioEl.volume);i.attachListener("loadeddata",()=>{s.set(o,()=>r.LOADED)});i.attachListener("loadstart",()=>{s.set(o,()=>r.LOADING)});i.attachListener("playing",()=>{s.set(o,()=>r.PLAYING)});i.attachListener("pause",()=>{s.set(o,()=>r.PAUSED)});i.attachListener("ended",()=>{s.set(o,()=>r.STOPPED)});i.attachListener("durationchange",()=>{s.set(h,(a={})=>({...a,meta:{...a.meta||{},duration:i.audioEl.duration}}))});i.attachListener("timeupdate",()=>{s.set(h,(a={})=>({meta:{...a.meta||{},currentTime:i.audioEl.currentTime}}))});i.attachListener("onvolumechange",()=>{s.set(P,()=>i.audioEl.volume)});i.attachListener("songchange",(a,e={})=>{var c,m,y,p,A;s.set(h,(w={})=>({...w,meta:e}));const t=x(),n=d((m=(c=e==null?void 0:e.coverArt)==null?void 0:c.thumbnails)==null?void 0:m.small),l=d((p=(y=e==null?void 0:e.coverArt)==null?void 0:y.thumbnails)==null?void 0:p.large),g=d((A=e==null?void 0:e.coverArt)==null?void 0:A.image),S=n||l||g||t;s.set(E,{image:g||l||n||t,thumbnail:n||l||g||t}),C(S)});async function C(a){if(a){const e=new Image;e.src=a,e.crossOrigin="Anonymous",e.onload=t=>{const n=v(e);s.set(q,n)}}}export{i as p};
