var f=Object.defineProperty;var b=(a,t,e)=>t in a?f(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var c=(a,t,e)=>(b(a,typeof t!="symbol"?t+"":t,e),e);import{g as v}from"./moonAndMusicImages-ee3f4190.js";import{p as n,b as o,a as r,d as h,e as I,f as P,c as C}from"./playerAtom-4c5f6d33.js";import{c as d}from"./helpers-b6ef1e89.js";import{c as M}from"./imageHelpers-8dffa84a.js";const D=()=>"mediaSession"in navigator,T=()=>navigator.mediaSession,E=a=>{D()&&(T().playbackState=a)};class w{constructor(){c(this,"listenSongChange");c(this,"seek",t=>{this.audioEl.currentTime=t});this.audioEl=new Audio,this.meta={}}attachListener(t,e){if(t==="songchange"){this.listenSongChange=e;return}this.audioEl.addEventListener(t,e)}load(t,e={}){this.listenSongChange(t,e),this.audioEl.src=t,this.audioEl.load(),this.meta=e}loadAndPlay(t,e={}){this.load(t,e),this.audioEl.play(),this.meta={...this.meta,...e}}play(){this.audioEl.play(),E("playing")}pause(){this.audioEl.pause(),E("paused")}changeVolume(t=0){this.audioEl.volume=t}}const s=new w;s.attachListener("loadeddata",()=>{n.set(o,()=>r.LOADED)});s.attachListener("loadstart",()=>{n.set(o,()=>r.LOADING)});s.attachListener("playing",()=>{n.set(o,()=>r.PLAYING)});s.attachListener("pause",()=>{n.set(o,()=>r.PAUSED)});s.attachListener("ended",()=>{n.set(o,()=>r.STOPPED)});s.attachListener("durationchange",()=>{n.set(h,(a={})=>({...a,meta:{...a.meta||{},duration:s.audioEl.duration}}))});s.attachListener("timeupdate",()=>{n.set(h,(a={})=>({meta:{...a.meta||{},currentTime:s.audioEl.currentTime}}))});s.attachListener("onvolumechange",()=>{n.set(I,()=>s.audioEl.volume)});s.attachListener("songchange",(a,t={})=>{var g,m,p,A,y;n.set(h,(L={})=>({...L,meta:t}));const e=v(),i=d((m=(g=t==null?void 0:t.coverArt)==null?void 0:g.thumbnails)==null?void 0:m.small),l=d((A=(p=t==null?void 0:t.coverArt)==null?void 0:p.thumbnails)==null?void 0:A.large),u=d((y=t==null?void 0:t.coverArt)==null?void 0:y.image),S=i||l||u||e;n.set(P,{image:u||l||i||e,thumbnail:i||l||u||e}),O(S)});async function O(a){if(a){const t=new Image;t.src=a,t.crossOrigin="Anonymous",t.onload=e=>{const i=M(t);n.set(C,i)}}}export{s as p};
