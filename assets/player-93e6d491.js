var f=Object.defineProperty;var b=(e,t,a)=>t in e?f(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a;var c=(e,t,a)=>(b(e,typeof t!="symbol"?t+"":t,a),a);import{g as v}from"./moonAndMusicImages-ee3f4190.js";import{E as n}from"./index-46666a37.js";import{a as i,p as r,b as h,d as I,e as P,c as C}from"./playerAtom-aaeeaf47.js";import{c as d}from"./helpers-b6ef1e89.js";import{c as M}from"./imageHelpers-8dffa84a.js";const D=()=>"mediaSession"in navigator,T=()=>navigator.mediaSession,E=e=>{D()&&(T().playbackState=e)};class w{constructor(){c(this,"listenSongChange");c(this,"seek",t=>{this.audioEl.currentTime=t});this.audioEl=new Audio,this.meta={}}attachListener(t,a){if(t==="songchange"){this.listenSongChange=a;return}this.audioEl.addEventListener(t,a)}load(t,a={}){this.listenSongChange(t,a),this.audioEl.src=t,this.audioEl.load(),this.meta=a}loadAndPlay(t,a={}){this.load(t,a),this.audioEl.play(),this.meta={...this.meta,...a}}play(){this.audioEl.play(),E("playing")}pause(){this.audioEl.pause(),E("paused")}changeVolume(t=0){this.audioEl.volume=t}}const s=new w;s.attachListener("loadeddata",()=>{n.set(i,()=>r.LOADED)});s.attachListener("loadstart",()=>{n.set(i,()=>r.LOADING)});s.attachListener("playing",()=>{n.set(i,()=>r.PLAYING)});s.attachListener("pause",()=>{n.set(i,()=>r.PAUSED)});s.attachListener("ended",()=>{n.set(i,()=>r.STOPPED)});s.attachListener("durationchange",()=>{n.set(h,(e={})=>({...e,meta:{...e.meta||{},duration:s.audioEl.duration}}))});s.attachListener("timeupdate",()=>{n.set(h,(e={})=>({meta:{...e.meta||{},currentTime:s.audioEl.currentTime}}))});s.attachListener("onvolumechange",()=>{n.set(I,()=>s.audioEl.volume)});s.attachListener("songchange",(e,t={})=>{var g,m,p,A,y;n.set(h,(L={})=>({...L,meta:t}));const a=v(),o=d((m=(g=t==null?void 0:t.coverArt)==null?void 0:g.thumbnails)==null?void 0:m.small),l=d((A=(p=t==null?void 0:t.coverArt)==null?void 0:p.thumbnails)==null?void 0:A.large),u=d((y=t==null?void 0:t.coverArt)==null?void 0:y.image),S=o||l||u||a;n.set(P,{image:u||l||o||a,thumbnail:o||l||u||a}),O(S)});async function O(e){if(e){const t=new Image;t.src=e,t.crossOrigin="Anonymous",t.onload=a=>{const o=M(t);n.set(C,o)}}}export{s as p};
